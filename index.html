<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>Aplikasi Nilai PABP</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <style>
        :root {
            --primary: #4361ee;
            --secondary: #7209b7;
            --bg-light: #f3f4f6;
            --col-no-width: 40px;
            --col-name-width: 250px;
        }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-light); font-size: 14px; color: #333; }
        
        /* HEADER & NAV */
        .app-header {
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            padding: 12px 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #e5e7eb;
        }
        /* PERBAIKAN LOGO: Dibuat responsive dan dibatasi tingginya */
        .logo-area img {
            max-height: 50px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }
        
        .custom-nav .nav-link { font-weight: 500; color: #6c757d; border-radius: 50px; margin: 2px; font-size: 12px; }
        .custom-nav .nav-link.active { background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%); color: white; box-shadow: 0 4px 10px rgba(67, 97, 238, 0.3); }
        .custom-nav .nav-link.active.bg-success-subtle { background: #198754 !important; color: white !important; }

        /* TABLE */
        .table-container { background: white; overflow: auto; max-height: 75vh; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        th {
            background-color: #f8f9fa; position: sticky; top: 0; z-index: 20;
            text-transform: uppercase; font-size: 11px; font-weight: 600;
            padding: 10px 5px; text-align: center; border-bottom: 2px solid #ddd;
            white-space: nowrap;
        }
        .th-lm { border-top: 3px solid #ffca3a !important; }
        .th-sas { border-top: 3px solid #ff595e !important; }
        td { padding: 4px; vertical-align: middle; border-bottom: 1px solid #f0f0f0; text-align: center; }
        
        .text-left { text-align: left !important; padding-left: 10px !important; }
        
        /* Sticky Columns */
        .sticky-no { position: sticky; left: 0; z-index: 10; background-color: white; width: var(--col-no-width); text-align: center; border-right: 1px solid #eee; }
        .sticky-nama { 
            position: sticky; left: var(--col-no-width); z-index: 10; 
            background-color: white; min-width: var(--col-name-width);
            border-right: 2px solid #e2e8f0; font-weight: 500;
            text-align: left !important; padding-left: 10px !important;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        th.sticky-no { z-index: 30; }
        th.sticky-nama { z-index: 30; left: var(--col-no-width); text-align: center !important; }
        
        input[type="number"] { width: 100%; min-width: 50px; text-align: center; border: 1px solid #dee2e6; border-radius: 4px; padding: 6px 0; font-size: 14px; }
        input[type="number"]:focus { outline: none; border-color: var(--primary); background: #eef2ff; }
        
        .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .btn-fab { border-radius: 50px; padding: 10px 15px; font-weight: 600; font-size: 12px; display: flex; gap: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        @media (max-width: 768px) {
            :root { var(--col-name-width: 140px; }
            .school-info h5 { font-size: 16px; }
            .controls-area { width: 100%; margin-top: 10px; }
            .input-group { width: 100% !important; }
            .sticky-nama { font-size: 12px; }
        }
        
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .d-print-none, .app-header, .fab-container { display: none !important; }
            .tab-content > .tab-pane { display: none; }
            #tab-rapor { display: block !important; opacity: 1 !important; visibility: visible !important; }
            .container-fluid { padding: 0 !important; margin: 0 !important; }
            #printArea { box-shadow: none !important; margin-top: 0 !important; }
            .table-container { max-height: none !important; overflow: visible !important; }
            table { width: 100% !important; border-collapse: collapse !important; }
            th, td { border: 1px solid black !important; padding: 4px !important; font-size: 11px !important; }
            .text-left { text-align: left !important; }
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
        <h6 class="fw-bold text-secondary">Menghubungkan Database...</h6>
        <small class="text-muted">Mohon tunggu sebentar</small>
    </div>

    <div class="app-header d-print-none">
        <div class="header-top d-flex flex-wrap align-items-center mb-3">
            <div class="logo-area me-3">
                <a href="https://freeimage.host/i/fx9qBjt" target="_blank">
                    <img src="https://iili.io/fx9qBjt.png" alt="Logo SMK" class="school-logo">
                </a>
            </div>
            <div class="school-info flex-grow-1">
                <h5 class="m-0 fw-bold text-dark lh-sm">SMK NEGERI 1 MALUKU TENGAH</h5>
                <div class="text-secondary small mt-1">
                    <i class="bi bi-book-half me-1 text-primary"></i> <strong>Pend. Agama & Budi Pekerti</strong>
                </div>
                <div class="text-secondary small">
                    <i class="bi bi-calendar-event me-1 text-primary"></i> TP. 2025/2026
                </div>
            </div>
            <div class="controls-area d-flex flex-column gap-2 align-items-end mt-2 mt-md-0">
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text bg-white fw-bold text-primary"><i class="bi bi-bookmark-star"></i></span>
                    <select id="semesterSelect" class="form-select border-start-0 fw-medium" onchange="updateHeaderInfo()">
                        <option value="Ganjil">Sem. Ganjil</option>
                        <option value="Genap">Sem. Genap</option>
                    </select>
                </div>
                <div class="input-group input-group-sm" style="width: 200px;">
                    <span class="input-group-text bg-light border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="searchInput" class="form-control bg-light border-start-0" placeholder="Cari Siswa...">
                </div>
            </div>
        </div>
        
        <ul class="nav nav-pills nav-fill custom-nav" id="myTab" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-datasiswa" type="button">
                    <i class="bi bi-person-vcard me-1"></i> DATA SISWA
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-formatif" type="button">
                    <i class="bi bi-pencil-square me-1"></i> FORMATIF
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-sumatif" type="button">
                    <i class="bi bi-calculator me-1"></i> SUMATIF
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link bg-success-subtle text-success fw-bold" data-bs-toggle="tab" data-bs-target="#tab-rapor" type="button">
                    <i class="bi bi-printer-fill me-1"></i> RAPOR
                </button>
            </li>
        </ul>
    </div>

    <div class="container-fluid px-2 pb-5 main-content">
        <div class="tab-content" id="myTabContent">
            
            <div class="tab-pane fade show active" id="tab-datasiswa">
                <div class="alert alert-light border shadow-sm mt-3 py-2 small text-muted">
                    <i class="bi bi-info-circle me-1"></i> Data Identitas Siswa
                </div>
                <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                    <div class="table-container">
                        <table class="table mb-0 table-hover table-striped">
                            <thead>
                                <tr>
                                    <th class="sticky-no">No</th>
                                    <th class="sticky-nama">Nama Siswa</th>
                                    <th>NIS</th>
                                    <th>NISN</th>
                                    <th>JK</th>
                                    <th style="min-width: 200px; text-align: left !important; padding-left: 15px !important;">Tempat Tanggal Lahir</th>
                                </tr>
                            </thead>
                            <tbody id="bodyDataSiswa"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-formatif">
                <div class="card shadow-sm border-0 rounded-4 overflow-hidden mt-3">
                    <div class="table-container">
                        <table class="table mb-0 table-hover">
                            <thead>
                                <tr>
                                    <th class="sticky-no">No</th>
                                    <th class="sticky-nama">Nama Siswa</th>
                                    <th>TP 1</th><th>TP 2</th><th>TP 3</th><th>TP 4</th><th>TP 5</th>
                                </tr>
                            </thead>
                            <tbody id="bodyFormatif"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-sumatif">
                <div class="d-flex justify-content-center mt-3 mb-2 d-print-none">
                    <div class="badge bg-white text-primary border shadow-sm px-3 py-2 rounded-pill fw-normal">
                        Rumus: (Rata LM × 60%) + (SAS × 40%)
                    </div>
                </div>
                <div class="card shadow-sm border-0 rounded-4 overflow-hidden">
                    <div class="table-container">
                        <table class="table mb-0 table-hover">
                            <thead>
                                <tr>
                                    <th class="sticky-no">No</th>
                                    <th class="sticky-nama">Nama Siswa</th>
                                    <th class="th-lm">LM 1</th><th class="th-lm">LM 2</th><th class="th-lm">LM 3</th>
                                    <th class="th-sas">SAS</th>
                                </tr>
                            </thead>
                            <tbody id="bodySumatif"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="tab-rapor">
                <div id="printArea" class="bg-white p-4 mt-3 rounded shadow-sm">
                    <div class="text-center mb-4 border-bottom pb-3 print-header">
                        <img src="https://iili.io/fx9qBjt.png" alt="Logo" style="height: 60px; object-fit: contain;" class="mb-2">
                        <h4 class="fw-bold m-0 text-uppercase">REKAPITULASI NILAI PABP</h4>
                        <h5 class="m-0">SMK NEGERI 1 MALUKU TENGAH</h5>
                        <p class="small text-muted m-0">Tahun Pelajaran 2025/2026 - <span id="printSemester">Semester Ganjil</span></p>
                    </div>
                    <table class="table table-bordered table-sm w-100" style="font-size: 12px;">
                        <thead class="table-light text-center align-middle">
                            <tr>
                                <th rowspan="2" style="width:30px;">No</th>
                                <th rowspan="2" style="width:25%;">Nama Siswa</th>
                                <th colspan="3">Identitas</th>
                                <th colspan="5">Formatif (TP)</th>
                                <th colspan="3">Sumatif (LM)</th>
                                <th rowspan="2">SAS</th>
                                <th rowspan="2" class="bg-success-subtle">Nilai<br>Akhir</th>
                                <th rowspan="2">Ket</th>
                            </tr>
                            <tr>
                                <th>NIS</th>
                                <th>NISN</th>
                                <th>JK</th>
                                <th>1</th><th>2</th><th>3</th><th>4</th><th>5</th>
                                <th>1</th><th>2</th><th>3</th>
                            </tr>
                        </thead>
                        <tbody id="bodyRapor"></tbody>
                    </table>
                    <div class="row mt-5">
                        <div class="col-4 text-center offset-8">
                            <p class="mb-5">Guru Mata Pelajaran</p>
                            <p class="fw-bold text-decoration-underline mt-5">_______________________</p>
                            <p>NIP. -</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="fab-container d-print-none">
        <button class="btn btn-secondary btn-fab shadow mb-2" onclick="printRapor()" title="Cetak / PDF">
            <i class="bi bi-printer-fill"></i> Cetak
        </button>
        <button class="btn btn-danger btn-fab shadow mb-2" onclick="resetData()" title="Hapus Semua Nilai">
            <i class="bi bi-trash3-fill"></i> Reset
        </button>
        <button class="btn btn-success btn-fab shadow mb-2" onclick="downloadExcel()" title="Download Excel">
            <i class="bi bi-file-earmark-excel-fill"></i> Excel
        </button>
        <button class="btn btn-primary btn-fab shadow" id="btnSave" onclick="saveData()" disabled>
            <i class="bi bi-floppy-fill"></i> <span id="btnSaveText">Simpan</span>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <script>
        // =========================================================================
        // KONFIGURASI PENTING
        // =========================================================================
        // Ganti URL di bawah ini dengan URL Web App dari Google Script Anda
        const API_URL = "https://script.google.com/macros/s/AKfycbxTMEmIoDz8Iw05O6mhOTAVi_wsZUoGj44rmPJGP0mdgkrhIK678wP84-5x4XzuKjcRQg/exec"; 
        // Contoh: "https://script.google.com/macros/s/AKfycbx.../exec"
        // =========================================================================

        let GLOBAL_DATA = [];
        let isDirty = false;

        window.onload = function() {
            fetchData();
        };

        function fetchData() {
            if (API_URL === "https://script.google.com/macros/s/AKfycbxTMEmIoDz8Iw05O6mhOTAVi_wsZUoGj44rmPJGP0mdgkrhIK678wP84-5x4XzuKjcRQg/exec") {
                alert("Harap ganti API_URL di dalam kode HTML dengan URL Web App Anda!");
                document.getElementById('loader').innerHTML = '<h6 class="text-danger">URL API Belum Dikonfigurasi</h6>';
                return;
            }

            // Gantikan google.script.run dengan fetch
            fetch(API_URL + "?action=read")
                .then(response => response.json())
                .then(data => {
                    initApp(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loader').innerHTML = 
                        `<h6 class="text-danger">Gagal memuat data!</h6><small>${error}</small>`;
                });
        }

        function initApp(data) {
            GLOBAL_DATA = data;
            renderDataSiswa();
            renderFormatif();
            renderSumatif();
            renderRapor();
            document.getElementById('loader').style.display = 'none';
        }

        function updateHeaderInfo() {
            document.getElementById('printSemester').innerText = "Semester " + document.getElementById('semesterSelect').value;
        }

        // --- RENDER FUNCTIONS (Sama seperti sebelumnya) ---

        function renderDataSiswa() {
            const tbody = document.getElementById('bodyDataSiswa');
            let rowsHTML = '';
            GLOBAL_DATA.forEach((row, idx) => {
                rowsHTML += `<tr>
                    <td class="sticky-no">${idx+1}</td>
                    <td class="sticky-nama">${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[4]}</td> <td class="text-left">${row[3]}</td> </tr>`;
            });
            tbody.innerHTML = rowsHTML;
        }

        function renderFormatif() {
            const tbody = document.getElementById('bodyFormatif');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let inputs = '';
                for(let i=5; i<=9; i++) inputs += createInput(idx, i, row[i]);
                html += `<tr>
                    <td class="sticky-no">${idx+1}</td>
                    <td class="sticky-nama text-truncate">${row[0]}</td>
                    ${inputs}
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderSumatif() {
            const tbody = document.getElementById('bodySumatif');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let inputsLM = '';
                for(let i=10; i<=12; i++) inputsLM += createInput(idx, i, row[i]);
                let inputSAS = createInput(idx, 13, row[13]);
                html += `<tr>
                    <td class="sticky-no">${idx+1}</td>
                    <td class="sticky-nama text-truncate">${row[0]}</td>
                    ${inputsLM}
                    ${inputSAS}
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderRapor() {
            const tbody = document.getElementById('bodyRapor');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let calc = calculateScore(row);
                const val = (idx) => row[idx] !== "" ? row[idx] : "-";
                let nis = row[1] || '-';
                let nisn = row[2] || '-';
                let jk = row[4] || '-';
                html += `<tr class="text-center">
                    <td>${idx+1}</td>
                    <td class="text-left text-nowrap sticky-nama">${row[0]}</td>
                    <td>${nis}</td>
                    <td>${nisn}</td>
                    <td>${jk}</td>
                    <td>${val(5)}</td><td>${val(6)}</td><td>${val(7)}</td><td>${val(8)}</td><td>${val(9)}</td>
                    <td>${val(10)}</td><td>${val(11)}</td><td>${val(12)}</td>
                    <td>${val(13)}</td>
                    <td class="fw-bold bg-light">${calc.rapor > 0 ? calc.rapor.toFixed(0) : ''}</td>
                    <td style="font-size:10px;">${calc.rapor >= 75 ? 'Tuntas' : ''}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function createInput(rowIdx, colIdx, val) {
            return `<td>
                <input type="number" value="${val}" data-r="${rowIdx}" data-c="${colIdx}" oninput="updateData(this)">
            </td>`;
        }

        function updateData(el) {
            let r = el.getAttribute('data-r');
            let c = el.getAttribute('data-c');
            GLOBAL_DATA[r][c] = el.value;
            if (!isDirty) {
                isDirty = true;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveText').innerText = 'Simpan*';
            }
        }

        const tabRapor = document.querySelector('button[data-bs-target="#tab-rapor"]');
        tabRapor.addEventListener('shown.bs.tab', function () { renderRapor(); });

        function calculateScore(row) {
            let sumLM = 0, countLM = 0;
            for(let i=10; i<=12; i++) {
                let v = parseFloat(row[i]);
                if(!isNaN(v) && row[i]!=="") { sumLM += v; countLM++; }
            }
            let sas = parseFloat(row[13]) || 0;
            let avgLM = countLM > 0 ? (sumLM/countLM) : 0;
            let rapor = 0;
            if(countLM > 0 || sas > 0) rapor = (avgLM * 0.6) + (sas * 0.4);
            return { rapor };
        }

        // --- SAVE & RESET (Menggunakan fetch POST) ---

        function saveData() {
            let btn = document.getElementById('btnSave');
            let txt = document.getElementById('btnSaveText');
            txt.innerText = 'Menyimpan...';
            btn.disabled = true;

            const payload = {
                action: 'save',
                data: GLOBAL_DATA
            };

            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
                alert(response.message);
                isDirty = false;
                txt.innerText = 'Simpan';
            })
            .catch(err => {
                alert("Gagal menyimpan: " + err);
                txt.innerText = 'Simpan';
                btn.disabled = false;
            });
        }

        function resetData() {
            if(!confirm("Hapus SEMUA NILAI?")) return;
            document.getElementById('loader').style.display = 'flex';
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'reset' })
            })
            .then(res => res.json())
            .then(response => {
                 GLOBAL_DATA.forEach(row => { for(let i=5; i<=13; i++) row[i]=""; });
                 renderFormatif(); renderSumatif(); renderRapor();
                 isDirty = false;
                 document.getElementById('btnSave').disabled = true;
                 document.getElementById('btnSaveText').innerText = 'Simpan';
                 document.getElementById('loader').style.display = 'none';
                 alert(response.message);
            })
            .catch(err => {
                document.getElementById('loader').style.display = 'none';
                alert("Gagal reset: " + err);
            });
        }

        function printRapor() {
            let bsTab = new bootstrap.Tab(document.querySelector('button[data-bs-target="#tab-rapor"]'));
            bsTab.show();
            setTimeout(() => window.print(), 500);
        }

        function downloadExcel() {
            let semester = document.getElementById('semesterSelect').value;
            let headers = ["No", "Nama Siswa", "NIS", "NISN", "JK", "Tempat Tanggal Lahir", "TP1", "TP2", "TP3", "TP4", "TP5", "LM1", "LM2", "LM3", "SAS", "Nilai Akhir"];

            let data = [
                ["REKAP NILAI PABP - SMK NEGERI 1 MALUKU TENGAH"],
                ["Semester: " + semester],
                [],
                headers
            ];
            GLOBAL_DATA.forEach((row, idx) => {
                let calc = calculateScore(row);
                let rowData = [
                    idx+1, row[0], row[1], row[2], row[4], row[3],
                    row[5], row[6], row[7], row[8], row[9],
                    row[10], row[11], row[12], row[13],
                    calc.rapor > 0 ? calc.rapor.toFixed(1) : ""
                ];
                data.push(rowData);
            });
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.writeFile(wb, "Rekap_Nilai_PABP.xlsx");
        }

        // Search Function
        document.getElementById('searchInput').addEventListener('keyup', function() {
            let key = this.value.toLowerCase();
            const ids = ['bodyDataSiswa', 'bodyFormatif', 'bodySumatif', 'bodyRapor'];
            ids.forEach(id => {
                let rows = document.getElementById(id).querySelectorAll('tr');
                rows.forEach(tr => {
                    let tdNama = tr.getElementsByTagName('td')[1];
                    if(tdNama) {
                        let txt = tdNama.textContent || tdNama.innerText;
                        tr.style.display = txt.toLowerCase().indexOf(key) > -1 ? "" : "none";
                    }
                });
            });
        });
    </script>
</body>
</html>
