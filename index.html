<script>
        // =========================================================================
        // KONFIGURASI PENTING
        // =========================================================================
        // URL Web App Anda (JANGAN UBAH BAGIAN INI LAGI, SUDAH BENAR)
        const API_URL = "https://script.google.com/macros/s/AKfycbxTMEmIoDz8Iw05O6mhOTAVi_wsZUoGj44rmPJGP0mdgkrhIK678wP84-5x4XzuKjcRQg/exec"; 
        // =========================================================================

        let GLOBAL_DATA = [];
        let isDirty = false;

        window.onload = function() {
            fetchData();
        };

        function fetchData() {
            // SAYA HAPUS PENGECEKAN IF YANG SALAH AGAR LANGSUNG JALAN
            
            // Tampilkan loader saat memuat
            document.getElementById('loader').style.display = 'flex';

            // Gantikan google.script.run dengan fetch
            fetch(API_URL + "?action=read")
                .then(response => response.json())
                .then(data => {
                    initApp(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loader').innerHTML = 
                        `<h6 class="text-danger">Gagal memuat data!</h6>
                         <small>Pastikan Deployment di Google Script sudah "Anyone"</small>
                         <br><small style="font-size:10px">${error}</small>`;
                });
        }

        function initApp(data) {
            GLOBAL_DATA = data;
            renderDataSiswa();
            renderFormatif();
            renderSumatif();
            renderRapor();
            document.getElementById('loader').style.display = 'none';
        }

        function updateHeaderInfo() {
            document.getElementById('printSemester').innerText = "Semester " + document.getElementById('semesterSelect').value;
        }

        // --- RENDER FUNCTIONS ---

        function renderDataSiswa() {
            const tbody = document.getElementById('bodyDataSiswa');
            let rowsHTML = '';
            if (GLOBAL_DATA.length === 0) {
                 rowsHTML = '<tr><td colspan="6" class="text-center">Belum ada data siswa</td></tr>';
            } else {
                GLOBAL_DATA.forEach((row, idx) => {
                    rowsHTML += `<tr>
                        <td class="sticky-no">${idx+1}</td>
                        <td class="sticky-nama">${row[0]}</td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[4]}</td> <td class="text-left">${row[3]}</td> </tr>`;
                });
            }
            tbody.innerHTML = rowsHTML;
        }

        function renderFormatif() {
            const tbody = document.getElementById('bodyFormatif');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let inputs = '';
                for(let i=5; i<=9; i++) inputs += createInput(idx, i, row[i]);
                html += `<tr>
                    <td class="sticky-no">${idx+1}</td>
                    <td class="sticky-nama text-truncate">${row[0]}</td>
                    ${inputs}
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderSumatif() {
            const tbody = document.getElementById('bodySumatif');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let inputsLM = '';
                for(let i=10; i<=12; i++) inputsLM += createInput(idx, i, row[i]);
                let inputSAS = createInput(idx, 13, row[13]);
                html += `<tr>
                    <td class="sticky-no">${idx+1}</td>
                    <td class="sticky-nama text-truncate">${row[0]}</td>
                    ${inputsLM}
                    ${inputSAS}
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function renderRapor() {
            const tbody = document.getElementById('bodyRapor');
            let html = '';
            GLOBAL_DATA.forEach((row, idx) => {
                let calc = calculateScore(row);
                const val = (idx) => row[idx] !== "" ? row[idx] : "-";
                let nis = row[1] || '-';
                let nisn = row[2] || '-';
                let jk = row[4] || '-';
                html += `<tr class="text-center">
                    <td>${idx+1}</td>
                    <td class="text-left text-nowrap sticky-nama">${row[0]}</td>
                    <td>${nis}</td>
                    <td>${nisn}</td>
                    <td>${jk}</td>
                    <td>${val(5)}</td><td>${val(6)}</td><td>${val(7)}</td><td>${val(8)}</td><td>${val(9)}</td>
                    <td>${val(10)}</td><td>${val(11)}</td><td>${val(12)}</td>
                    <td>${val(13)}</td>
                    <td class="fw-bold bg-light">${calc.rapor > 0 ? calc.rapor.toFixed(0) : ''}</td>
                    <td style="font-size:10px;">${calc.rapor >= 75 ? 'Tuntas' : ''}</td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function createInput(rowIdx, colIdx, val) {
            return `<td>
                <input type="number" value="${val}" data-r="${rowIdx}" data-c="${colIdx}" oninput="updateData(this)">
            </td>`;
        }

        function updateData(el) {
            let r = el.getAttribute('data-r');
            let c = el.getAttribute('data-c');
            GLOBAL_DATA[r][c] = el.value;
            if (!isDirty) {
                isDirty = true;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnSaveText').innerText = 'Simpan*';
            }
        }

        const tabRapor = document.querySelector('button[data-bs-target="#tab-rapor"]');
        tabRapor.addEventListener('shown.bs.tab', function () { renderRapor(); });

        function calculateScore(row) {
            let sumLM = 0, countLM = 0;
            for(let i=10; i<=12; i++) {
                let v = parseFloat(row[i]);
                if(!isNaN(v) && row[i]!=="") { sumLM += v; countLM++; }
            }
            let sas = parseFloat(row[13]) || 0;
            let avgLM = countLM > 0 ? (sumLM/countLM) : 0;
            let rapor = 0;
            if(countLM > 0 || sas > 0) rapor = (avgLM * 0.6) + (sas * 0.4);
            return { rapor };
        }

        // --- SAVE & RESET (Menggunakan fetch POST) ---

        function saveData() {
            let btn = document.getElementById('btnSave');
            let txt = document.getElementById('btnSaveText');
            txt.innerText = 'Menyimpan...';
            btn.disabled = true;

            const payload = {
                action: 'save',
                data: GLOBAL_DATA
            };

            // Menggunakan no-cors jika perlu, tapi biasanya web app mengembalikan JSON
            // Jika ada masalah CORS, pastikan doGet/doPost mengembalikan TextOutput JSON
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(response => {
                alert(response.message);
                isDirty = false;
                txt.innerText = 'Simpan';
            })
            .catch(err => {
                // Kadang sukses tapi browser memblokir response karena CORS
                // Jika data tersimpan di sheet tapi muncul error disini, itu normal di simple trigger
                console.log(err); 
                alert("Respon server diterima. Cek sheet untuk memastikan data tersimpan.");
                txt.innerText = 'Simpan';
                btn.disabled = false;
            });
        }

        function resetData() {
            if(!confirm("Hapus SEMUA NILAI?")) return;
            document.getElementById('loader').style.display = 'flex';
            
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'reset' })
            })
            .then(res => res.json())
            .then(response => {
                 GLOBAL_DATA.forEach(row => { for(let i=5; i<=13; i++) row[i]=""; });
                 renderFormatif(); renderSumatif(); renderRapor();
                 isDirty = false;
                 document.getElementById('btnSave').disabled = true;
                 document.getElementById('btnSaveText').innerText = 'Simpan';
                 document.getElementById('loader').style.display = 'none';
                 alert(response.message);
            })
            .catch(err => {
                document.getElementById('loader').style.display = 'none';
                alert("Error reset: " + err);
            });
        }

        function printRapor() {
            let bsTab = new bootstrap.Tab(document.querySelector('button[data-bs-target="#tab-rapor"]'));
            bsTab.show();
            setTimeout(() => window.print(), 500);
        }

        function downloadExcel() {
            let semester = document.getElementById('semesterSelect').value;
            let headers = ["No", "Nama Siswa", "NIS", "NISN", "JK", "Tempat Tanggal Lahir", "TP1", "TP2", "TP3", "TP4", "TP5", "LM1", "LM2", "LM3", "SAS", "Nilai Akhir"];

            let data = [
                ["REKAP NILAI PABP - SMK NEGERI 1 MALUKU TENGAH"],
                ["Semester: " + semester],
                [],
                headers
            ];
            GLOBAL_DATA.forEach((row, idx) => {
                let calc = calculateScore(row);
                let rowData = [
                    idx+1, row[0], row[1], row[2], row[4], row[3],
                    row[5], row[6], row[7], row[8], row[9],
                    row[10], row[11], row[12], row[13],
                    calc.rapor > 0 ? calc.rapor.toFixed(1) : ""
                ];
                data.push(rowData);
            });
            let wb = XLSX.utils.book_new();
            let ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.writeFile(wb, "Rekap_Nilai_PABP.xlsx");
        }

        // Search Function
        document.getElementById('searchInput').addEventListener('keyup', function() {
            let key = this.value.toLowerCase();
            const ids = ['bodyDataSiswa', 'bodyFormatif', 'bodySumatif', 'bodyRapor'];
            ids.forEach(id => {
                let rows = document.getElementById(id).querySelectorAll('tr');
                rows.forEach(tr => {
                    let tdNama = tr.getElementsByTagName('td')[1];
                    if(tdNama) {
                        let txt = tdNama.textContent || tdNama.innerText;
                        tr.style.display = txt.toLowerCase().indexOf(key) > -1 ? "" : "none";
                    }
                });
            });
        });
    </script>
